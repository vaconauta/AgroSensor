<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AgroSensor</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            align-items: start;
            grid-auto-rows: min-content;
        }
        
        .chart-container {
            position: relative;
            height: 450px;
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid var(--border-gray);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .chart-container canvas {
            max-height: 360px !important;
            width: 100% !important;
            height: 360px !important;
            display: block;
            box-sizing: border-box;
        }
        
        /* Melhorar espaçamento entre elementos dos gráficos */
        .chart-header {
            flex-shrink: 0;
            min-height: 60px;
        }
        
        .chart-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .filter-selector {
            min-width: 120px;
            flex-shrink: 0;
        }
        
        /* Garantir que não há overflow ou sobreposição */
        .dashboard-content * {
            box-sizing: border-box;
        }
        
        .chart-container * {
            position: relative;
            z-index: 1;
        }
        
        /* Melhor controle de texto nos gráficos */
        .chart-container .chartjs-tooltip {
            z-index: 1000 !important;
        }
        
        /* Evitar sobreposição de elementos */
        .col-4 {
            min-width: 0;
            overflow: hidden;
        }
        
        /* Links desabilitados */
        .sidebar-nav-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            position: relative;
        }
        
        .sidebar-nav-link.disabled::after {
            content: "Em breve";
            position: absolute;
            right: 12px;
            font-size: 0.75rem;
            background: var(--text-gray);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-gray);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chart-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .filter-selector {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--white);
            cursor: pointer;
        }
        
        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-gray);
            text-align: center;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background: var(--light-gray);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .status-dot.offline {
            background: var(--error);
        }
        
        .latest-readings {
            background: var(--white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-gray);
            box-shadow: var(--shadow-sm);
        }
        
        .readings-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .readings-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .reading-item {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }
        
        .reading-item:last-child {
            border-bottom: none;
        }
        
        .reading-item:hover {
            background: var(--light-gray);
        }
        
        .reading-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .reading-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.125rem;
        }
        
        .reading-icon.humidity {
            background: linear-gradient(135deg, var(--info), #63b3ed);
        }
        
        .reading-icon.rain {
            background: linear-gradient(135deg, var(--accent-green), var(--light-green));
        }
        
        .reading-details h6 {
            margin: 0 0 var(--spacing-xs) 0;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .reading-details p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-gray);
        }
        
        .reading-values {
            text-align: right;
        }
        
        .reading-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: var(--spacing-xs);
        }
        
        .reading-time {
            font-size: 0.75rem;
            color: var(--text-gray);
        }
        
        .empty-state {
            padding: var(--spacing-2xl);
            text-align: center;
            color: var(--text-gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="navbar-brand">
                <i class="fas fa-seedling"></i>
                <span>AgroSensor</span>
            </div>
            <p class="subtitle" style="color: var(--text-gray); font-size: 0.875rem; margin-top: var(--spacing-sm);">
                Plano Básico
            </p>
        </div>
        
        <nav>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="dashboard.html" class="sidebar-nav-link active">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="dispositivos.html" class="sidebar-nav-link">
                        <i class="fas fa-microchip"></i>
                        Dispositivos
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="dados.html" class="sidebar-nav-link">
                        <i class="fas fa-database"></i>
                        Dados
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link disabled">
                        <i class="fas fa-tint"></i>
                        Irrigação
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="configuracoes.html" class="sidebar-nav-link">
                        <i class="fas fa-cog"></i>
                        Configurações
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <div id="adminNavItem" class="sidebar-nav-item" style="display: none;">
                <a href="admin-dashboard.html" class="sidebar-nav-link">
                    <i class="fas fa-user-shield"></i>
                    Painel Admin
                </a>
            </div>
            <div class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </a>
            </div>
            <div style="padding: var(--spacing-md); text-align: center; font-size: 0.75rem; color: var(--text-gray);">
                <div style="margin-bottom: 4px;">
                    <i class="fas fa-user"></i>
                    <span id="userInfo">Carregando...</span>
                </div>
                <div id="companyInfo" style="font-size: 0.7rem; opacity: 0.8;">
                    <i class="fas fa-building"></i>
                    <span id="companyName">-</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="content-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>Dashboard</h1>
                    <p class="mb-0 text-muted">Visão geral do sistema de monitoramento</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary" onclick="loadDashboardData()">
                        <i class="fas fa-sync-alt"></i>
                        Atualizar
                    </button>
                    <button class="btn btn-primary" data-sidebar-toggle style="display: none;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="content-body">
            <!-- Status Cards -->
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-card-icon primary">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="stats-card-value" id="deviceCount">0</div>
                    <div class="stats-card-label">Dispositivos Ativos</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-icon info">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <div class="stats-card-value" id="avgHumidity">0%</div>
                    <div class="stats-card-label">Umidade Média</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-icon warning">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="stats-card-value" id="totalRain">0mm</div>
                    <div class="stats-card-label">Chuva Total</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-icon success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stats-card-value" id="readingCount">0</div>
                    <div class="stats-card-label">Leituras Hoje</div>
                </div>
            </div>
            
            <!-- Status do Dispositivo -->
            <div id="deviceStatusContainer"></div>
            
            <!-- Gráficos -->
            <div class="row">
                <div class="col-8">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-area"></i>
                                Umidade do Solo
                            </h3>
                            <div class="chart-actions">
                                <select class="filter-selector" id="humidityFilter" onchange="updateHumidityChart()">
                                    <option value="24h">Últimas 24h</option>
                                    <option value="7d">Últimos 7 dias</option>
                                    <option value="30d">Últimos 30 dias</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="humidityChart"></canvas>
                    </div>
                </div>
                
                <div class="col-4">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Quantidade de Chuva
                            </h3>
                            <div class="chart-actions">
                                <select class="filter-selector" id="rainFilter" onchange="updateRainChart()">
                                    <option value="24h">Últimas 24h</option>
                                    <option value="7d">Últimos 7 dias</option>
                                    <option value="30d">Últimos 30 dias</option>
                                </select>
                            </div>
                        </div>
                        <canvas id="rainChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Leituras Recentes -->
            <div class="latest-readings">
                <div class="readings-header">
                    <h3 class="mb-0">
                        <i class="fas fa-history"></i>
                        Leituras Recentes
                    </h3>
                    <a href="dados.html" class="btn btn-sm btn-secondary">
                        Ver todas <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="readings-list" id="latestReadings">
                    <!-- Será preenchido via JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../assets/js/app.js"></script>
    <script>
        // Variáveis globais dos gráficos
        let humidityChart = null;
        let rainChart = null;
        
        // Função de inicialização e verificações
        function initPage() {
            // Verificar autenticação e permissões
            if (!AuthManager.redirectIfNotAuthenticated()) {
                throw new Error('Não autenticado');
            }

            // Verificar se é usuário comum - admins devem ir para admin-dashboard
            if (AuthManager.isAdmin()) {
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.get('company_id')) {
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
            }
        }
        
        // Executar verificações
        initPage();

        // Função helper para notificações
        function showNotification(type, title, message) {
            if (window.NotificationManager && typeof window.NotificationManager[type] === 'function') {
                window.NotificationManager[type](title, message);
            } else {
                // Fallback para alert se NotificationManager não estiver disponível
                alert(`${title}: ${message}`);
            }
        }
        
        // Função para interceptar cliques em links desabilitados
        function handleDisabledLinks() {
            document.querySelectorAll('.sidebar-nav-link.disabled').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showNotification('info', 'Funcionalidade em desenvolvimento', 'Esta funcionalidade estará disponível em breve.');
                });
            });
        }

        // Obter company_id para administradores via query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const adminCompanyId = urlParams.get('company_id');
        const isAdminView = urlParams.get('admin') === 'true';

        // Dados simulados (será substituído por dados reais da API)
        let sensorsData = [];
        let latestReadings = [];
        
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeDashboard();
            setupEventListeners();
            handleDisabledLinks();
        });
        
        async function initializeDashboard() {
            try {
                LoadingManager.showGlobalLoading('Carregando dashboard...');
                
                // Carregar dados do usuário
                const user = AuthManager.getUserFromToken();
                if (user) {
                    const displayName = user.fullName || user.username || 'Usuário';
                    document.getElementById('userInfo').textContent = displayName;
                    
                    // Mostrar informações baseadas no tipo de usuário
                    if (user.userType === 'admin') {
                        document.getElementById('adminNavItem').style.display = 'block';
                        if (adminCompanyId) {
                            // Admin visualizando empresa específica
                            document.getElementById('userInfo').textContent += ' (Admin)';
                            await loadCompanyName(adminCompanyId);
                        }
                    } else if (user.userType === 'user' && user.company_id) {
                        // Usuário comum - carregar nome da empresa
                        await loadCompanyName(user.company_id);
                    }
                }
                
                // Inicializar gráficos primeiro
                initializeCharts();
                
                // Carregar dados do dashboard
                await loadDashboardData();
                
            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
                showNotification('error', 'Erro', 'Falha ao carregar dados do dashboard');
            } finally {
                LoadingManager.hideGlobalLoading();
            }
        }

        async function loadCompanyName(companyId) {
            try {
                // Para usuários comuns, a empresa pode vir da API de configurações
                // Para admins, carregamos da API administrativa
                const user = AuthManager.getUserFromToken();
                if (user.userType === 'admin') {
                    const companies = await ApiClient.getCompanies();
                    const company = companies.companies?.find(c => c._id === companyId);
                    if (company) {
                        document.getElementById('companyName').textContent = company.nome;
                    }
                } else {
                    // Para usuários comuns, podemos tentar obter da configuração
                    document.getElementById('companyName').textContent = 'Minha Empresa';
                }
            } catch (error) {
                console.error('Erro ao carregar nome da empresa:', error);
                document.getElementById('companyName').textContent = '-';
            }
        }
        
        async function loadDashboardData() {
            try {
                // Determinar company_id para carregar dados
                const companyId = adminCompanyId || AuthManager.getCompanyId();
                
                // Carregar histórico de sensores
                const historyData = await ApiClient.getSensorsHistory(adminCompanyId);
                sensorsData = historyData || [];
                
                // Processar dados para estatísticas
                updateStatistics();
                
                // Atualizar status do dispositivo
                updateDeviceStatus();
                
                // Atualizar leituras recentes
                updateLatestReadings();
                
                // Atualizar gráficos
                updateCharts();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                // Mostrar dados simulados em caso de erro
                loadMockData();
            }
        }
        
        function loadMockData() {
            // Dados simulados para demonstração
            const now = new Date();
            sensorsData = [];
            
            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(now.getTime() - (i * 30 * 60 * 1000)); // 30 min intervals
                sensorsData.push({
                    _id: `mock_${i}`,
                    device_key: 'MOCK_DEVICE_KEY',
                    umidade_solo: Math.random() * 40 + 30, // 30-70%
                    quantidade_chuva: Math.random() * 5, // 0-5mm
                    timestamp: timestamp.toISOString()
                });
            }
            
            sensorsData.reverse(); // Mais antigo primeiro
            updateStatistics();
            updateDeviceStatus();
            updateLatestReadings();
            updateCharts();
        }
        
        function updateStatistics() {
            // Calcular estatísticas
            const deviceCount = sensorsData.length > 0 ? 1 : 0;
            const avgHumidity = sensorsData.length > 0 
                ? (sensorsData.reduce((sum, item) => sum + item.umidade_solo, 0) / sensorsData.length)
                : 0;
            const totalRain = sensorsData.reduce((sum, item) => sum + item.quantidade_chuva, 0);
            
            // Leituras de hoje
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const readingsToday = sensorsData.filter(item => 
                new Date(item.timestamp) >= today
            ).length;
            
            // Atualizar UI
            document.getElementById('deviceCount').textContent = deviceCount;
            document.getElementById('avgHumidity').textContent = avgHumidity.toFixed(1) + '%';
            document.getElementById('totalRain').textContent = totalRain.toFixed(1) + 'mm';
            document.getElementById('readingCount').textContent = readingsToday;
        }
        
        function updateDeviceStatus() {
            const container = document.getElementById('deviceStatusContainer');
            
            if (sensorsData.length === 0) {
                container.innerHTML = `
                    <div class="device-status">
                        <div class="status-dot offline"></div>
                        <div>
                            <strong>Nenhum dispositivo cadastrado</strong>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-gray);">
                                Configure um dispositivo para começar a receber dados
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Verificar última leitura
            const lastReading = sensorsData[sensorsData.length - 1];
            const lastTime = new Date(lastReading.timestamp);
            const timeDiff = Date.now() - lastTime.getTime();
            const isOnline = timeDiff < 30 * 60 * 1000; // 30 minutos
            
            container.innerHTML = `
                <div class="device-status">
                    <div class="status-dot ${isOnline ? '' : 'offline'}"></div>
                    <div>
                        <strong>Dispositivo ${isOnline ? 'Online' : 'Offline'}</strong>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-gray);">
                            Última leitura: ${Utils.formatDate(lastTime, 'dd/MM/yyyy HH:mm')}
                        </p>
                    </div>
                </div>
            `;
        }
        
        function updateLatestReadings() {
            const container = document.getElementById('latestReadings');
            
            if (sensorsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <h4>Nenhuma leitura disponível</h4>
                        <p>Os dados dos sensores aparecerão aqui quando disponíveis</p>
                    </div>
                `;
                return;
            }
            
            // Pegar últimas 5 leituras
            const recent = sensorsData.slice(-5).reverse();
            
            let html = '';
            recent.forEach(reading => {
                html += `
                    <div class="reading-item">
                        <div class="reading-info">
                            <div class="reading-icon humidity">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="reading-details">
                                <h6>Umidade do Solo</h6>
                                <p>Sensor Principal</p>
                            </div>
                        </div>
                        <div class="reading-values">
                            <div class="reading-value">${Utils.formatNumber(reading.umidade_solo)}%</div>
                            <div class="reading-time">${Utils.formatDate(reading.timestamp, 'dd/MM/yyyy HH:mm')}</div>
                        </div>
                    </div>
                    <div class="reading-item">
                        <div class="reading-info">
                            <div class="reading-icon rain">
                                <i class="fas fa-cloud-rain"></i>
                            </div>
                            <div class="reading-details">
                                <h6>Quantidade de Chuva</h6>
                                <p>Pluviômetro</p>
                            </div>
                        </div>
                        <div class="reading-values">
                            <div class="reading-value">${Utils.formatNumber(reading.quantidade_chuva)}mm</div>
                            <div class="reading-time">${Utils.formatDate(reading.timestamp, 'dd/MM/yyyy HH:mm')}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function initializeCharts() {
            // Configuração comum dos gráficos
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.color = '#4a5568';
            
            // Gráfico de Umidade
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Umidade do Solo (%)',
                        data: [],
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 30,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            display: true
                        }
                    },
                    elements: {
                        point: {
                            radius: 3,
                            hoverRadius: 6
                        }
                    }
                }
            });
            
            // Gráfico de Chuva
            const rainCtx = document.getElementById('rainChart').getContext('2d');
            rainChart = new Chart(rainCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Quantidade de Chuva (mm)',
                        data: [],
                        backgroundColor: '#7fb069',
                        borderColor: '#2d5a27',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 30,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + 'mm';
                                }
                            }
                        }
                    }
                }
            });
            
            updateCharts();
        }
        
        function updateCharts() {
            updateHumidityChart();
            updateRainChart();
        }
        
        function updateHumidityChart() {
            // Verificar se o gráfico foi inicializado
            if (!humidityChart) {
                console.warn('Gráfico de umidade não foi inicializado ainda');
                return;
            }
            
            const filter = document.getElementById('humidityFilter').value;
            const filteredData = filterDataByTime(sensorsData, filter);
            
            if (filteredData.length === 0) {
                humidityChart.data.labels = [];
                humidityChart.data.datasets[0].data = [];
                humidityChart.update();
                return;
            }
            
            const labels = filteredData.map(item => {
                const date = new Date(item.timestamp);
                return filter === '24h' 
                    ? date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString('pt-BR', { month: 'short', day: '2-digit' });
            });
            
            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = filteredData.map(item => item.umidade_solo);
            humidityChart.update();
        }
        
        function updateRainChart() {
            // Verificar se o gráfico foi inicializado
            if (!rainChart) {
                console.warn('Gráfico de chuva não foi inicializado ainda');
                return;
            }
            
            const filter = document.getElementById('rainFilter').value;
            const filteredData = filterDataByTime(sensorsData, filter);
            
            if (filteredData.length === 0) {
                rainChart.data.labels = [];
                rainChart.data.datasets[0].data = [];
                rainChart.update();
                return;
            }
            
            const labels = filteredData.map(item => {
                const date = new Date(item.timestamp);
                return filter === '24h' 
                    ? date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString('pt-BR', { month: 'short', day: '2-digit' });
            });
            
            rainChart.data.labels = labels;
            rainChart.data.datasets[0].data = filteredData.map(item => item.quantidade_chuva);
            rainChart.update();
        }
        
        function filterDataByTime(data, filter) {
            const now = new Date();
            let cutoff;
            
            switch (filter) {
                case '24h':
                    cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '30d':
                    cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            }
            
            return data.filter(item => new Date(item.timestamp) >= cutoff);
        }
        
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                AuthManager.logout();
            });
            
            // Toggle sidebar para mobile
            const sidebarToggle = document.querySelector('[data-sidebar-toggle]');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    const sidebar = document.querySelector('.sidebar');
                    sidebar.classList.toggle('show');
                });
            }
            
            // Atualização automática a cada 5 minutos
            setInterval(loadDashboardData, 5 * 60 * 1000);
        }
        
        // Mostrar/esconder toggle de sidebar em telas pequenas
        function checkScreenSize() {
            const toggle = document.querySelector('[data-sidebar-toggle]');
            if (window.innerWidth <= 1024) {
                toggle.style.display = 'flex';
            } else {
                toggle.style.display = 'none';
            }
        }
        
        window.addEventListener('resize', checkScreenSize);
        checkScreenSize();
    </script>
</body>
</html>