<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Vento - WR10</title>
    <meta name="description" content="Monitoramento de velocidade e direção do vento - Acompanhe as condições do vento em tempo real">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/img/logo.svg">
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <!-- Router para navegação otimizada -->
    <script src="../assets/js/router.js"></script>
    
    <style>
        /* Estilos específicos para a página de vento */
        .wind-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .wind-stat-card {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .wind-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .wind-stat-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .wind-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--white);
            flex-shrink: 0;
        }

        .wind-stat-icon.speed {
            background: linear-gradient(135deg, var(--info), #2c5aa0);
        }

        .wind-stat-icon.direction {
            background: linear-gradient(135deg, var(--success), #2f855a);
        }

        .wind-stat-icon.gust {
            background: linear-gradient(135deg, var(--error), #c53030);
        }

        .wind-stat-icon.pressure {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
        }

        .wind-stat-content {
            flex: 1;
        }

        .wind-stat-content h3 {
            margin: 0 0 var(--spacing-xs) 0;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .wind-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin: var(--spacing-xs) 0;
            line-height: 1.2;
        }

        .wind-stat-unit {
            font-size: 0.875rem;
            color: var(--text-gray);
            font-weight: 400;
            margin-left: var(--spacing-xs);
        }

        .wind-stat-trend {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.85rem;
            margin-top: var(--spacing-sm);
        }

        .trend-up {
            color: var(--error);
        }

        .trend-down {
            color: var(--success);
        }

        .trend-stable {
            color: var(--text-gray);
        }

        /* Compass para direção do vento - Versão Melhorada */
        .wind-compass {
            width: 200px;
            height: 200px;
            margin: var(--spacing-lg) auto 0;
            position: relative;
            border-radius: 50%;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Círculos concêntricos de fundo */
        .wind-compass::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 85%;
            border-radius: 50%;
            border: 2px dashed rgba(124, 179, 66, 0.2);
        }

        .wind-compass::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            border-radius: 50%;
            border: 2px dashed rgba(124, 179, 66, 0.1);
        }

        .compass-face {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 50%;
        }

        /* Centro decorativo da bússola */
        .compass-face::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-green), #2d7a3e);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.3);
            z-index: 10;
        }

        .compass-direction {
            position: absolute;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--dark-gray);
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            z-index: 5;
        }

        .compass-direction.north { 
            top: 6px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 1rem;
            color: var(--error);
        }
        .compass-direction.east { 
            right: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
        }
        .compass-direction.south { 
            bottom: 6px; 
            left: 50%; 
            transform: translateX(-50%); 
        }
        .compass-direction.west { 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
        }

        /* Pontos cardeais intermediários */
        .compass-direction.northeast { 
            top: 18px; 
            right: 18px; 
            font-size: 0.7rem;
            color: var(--text-gray);
        }
        .compass-direction.southeast { 
            bottom: 18px; 
            right: 18px; 
            font-size: 0.7rem;
            color: var(--text-gray);
        }
        .compass-direction.southwest { 
            bottom: 18px; 
            left: 18px; 
            font-size: 0.7rem;
            color: var(--text-gray);
        }
        .compass-direction.northwest { 
            top: 18px; 
            left: 18px; 
            font-size: 0.7rem;
            color: var(--text-gray);
        }

        .wind-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform-origin: 50% 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 8;
        }

        /* Seta principal */
        .wind-arrow::before {
            content: '';
            position: absolute;
            top: -70px;
            left: -3px;
            width: 6px;
            height: 70px;
            background: linear-gradient(180deg, var(--error) 0%, #c53030 100%);
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
        }

        /* Ponta da seta */
        .wind-arrow::after {
            content: '';
            position: absolute;
            top: -82px;
            left: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 18px solid var(--error);
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        }

        /* Gráficos de vento */
        .wind-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .wind-charts-grid {
                grid-template-columns: 1fr;
            }
            
            .wind-compass {
                width: 180px;
                height: 180px;
            }
        }

        .chart-container {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            height: 450px;
            box-shadow: var(--shadow-sm);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-gray);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .chart-title i {
            color: var(--accent-green);
        }

        .filter-selector {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--dark-gray);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-selector:hover {
            border-color: var(--accent-green);
        }

        .filter-selector:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(124, 179, 66, 0.1);
        }

        /* Rosa dos ventos simplificada */
        .wind-rose-container {
            background: var(--white);
            border: 1px solid var(--border-gray);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .wind-rose-container .chart-title {
            margin-bottom: var(--spacing-xl);
            justify-content: center;
        }

        .wind-rose {
            width: 450px;
            height: 450px;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .wind-rose canvas {
            max-width: 100%;
            max-height: 100%;
        }

        @media (max-width: 768px) {
            .wind-rose {
                width: 380px;
                height: 380px;
            }
        }

        @media (max-width: 480px) {
            .wind-rose {
                width: 320px;
                height: 320px;
            }
            

        }

        /* Links desabilitados */
        .sidebar-nav-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            position: relative;
        }
        
        .sidebar-nav-link.disabled::after {
            content: "Em breve";
            position: absolute;
            right: 12px;
            font-size: 0.75rem;
            background: var(--text-gray);
            color: var(--white);
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* ===== MENU HAMBURGUER ===== */
        .btn-hamburger {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 44px;
            height: 44px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-md);
            transition: var(--transition);
            position: relative;
        }
        
        .btn-hamburger:hover {
            background: var(--light-gray);
        }
        
        .btn-hamburger:active {
            background: var(--medium-gray);
        }
        
        .hamburger-line {
            display: block;
            height: 3px;
            width: 100%;
            background: var(--dark-gray);
            border-radius: 2px;
            transition: var(--transition);
            transform-origin: center;
        }
        
        /* Animação do hamburguer para X */
        .btn-hamburger.active .hamburger-line:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }
        
        .btn-hamburger.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .btn-hamburger.active .hamburger-line:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }

        /* Overlay para fechar sidebar ao clicar fora */
        .sidebar-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 999 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transition: var(--transition) !important;
            pointer-events: none !important;
        }
        
        .sidebar-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .btn-hamburger {
                display: flex !important;
            }
            
            .sidebar {
                transform: translateX(-100%) !important;
                transition: transform 0.3s ease !important;
                z-index: 1001 !important;
                position: fixed !important;
            }
            
            .sidebar.show {
                transform: translateX(0) !important;
                box-shadow: var(--shadow-xl) !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                transition: margin-left 0.3s ease !important;
            }
        }
        
        /* Regras adicionais para garantir funcionamento */
        @media (max-width: 1024px) {
            .sidebar {
                left: 0 !important;
                top: 0 !important;
                width: 280px !important;
                height: 100vh !important;
                background: var(--white) !important;
            }
        }
        
        /* Melhorias adicionais para telas muito pequenas */
        @media (max-width: 768px) {
            .content-header h1 {
                font-size: 1.5rem;
            }
            
            .content-header p {
                font-size: 0.875rem;
            }
            
            .btn-hamburger {
                width: 40px;
                height: 40px;
            }
        }
        
        /* CSS SIMPLIFICADO - só o essencial */
        @media (max-width: 1024px) {
            .btn-hamburger {
                display: flex !important;
                position: absolute !important;
                right: 20px !important;
                top: 20px !important;
                z-index: 100 !important;
            }
        }

        /* Garantir que o header tenha position relative */
        .content-header {
            position: relative !important;
        }

        /* Classes auxiliares para layout */
        .d-flex {
            display: flex !important;
        }

        .justify-content-between {
            justify-content: space-between !important;
        }

        .align-items-start {
            align-items: flex-start !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .ml-auto {
            margin-left: auto !important;
        }
    </style>
</head>

<body>
    <!-- Admin View Status Bar -->
    <div id="adminStatusBar" class="admin-status-bar" style="display: none;">
        <div class="admin-status-content">
            <i class="fas fa-user-shield"></i>
            <span>Visualização Administrativa - Empresa: <span id="adminCompanyName">Carregando...</span></span>
            <button onclick="exitAdminView()" class="btn-admin-exit">
                <i class="fas fa-times"></i> Sair
            </button>
        </div>
    </div>
    
    <!-- Overlay para fechar sidebar em mobile -->
    <div class="sidebar-overlay" data-sidebar-overlay></div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="navbar-brand">
                <img src="../assets/img/logo.svg" alt="WR10" width="32" height="32">
                <span>WR10</span>
            </div>
            <p class="subtitle" style="color: var(--text-gray); font-size: 0.875rem; margin-top: var(--spacing-sm);">
                Sistema de Monitoramento Agrícola
            </p>
        </div>
        
        <nav>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="dashboard.html" class="sidebar-nav-link">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="dispositivos.html" class="sidebar-nav-link">
                        <i class="fas fa-microchip"></i>
                        Estações
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="dados.html" class="sidebar-nav-link">
                        <i class="fas fa-database"></i>
                        Dados
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="vento.html" class="sidebar-nav-link active">
                        <i class="fas fa-wind"></i>
                        Vento
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link disabled">
                        <i class="fas fa-tint"></i>
                        Irrigação
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="configuracoes.html" class="sidebar-nav-link">
                        <i class="fas fa-cog"></i>
                        Configurações
                    </a>
                </li>
            </ul>
        </nav>
        
        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <div class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </a>
            </div>
            <div style="padding: var(--spacing-md); text-align: center; font-size: 0.75rem; color: var(--text-gray);">
                © 2024 WR10
            </div>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="main-content">
        <div class="content-header">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h1 class="mb-1">Monitoramento de Vento</h1>
                            <p class="mb-0 text-muted">Acompanhe velocidade, direção e rajadas de vento em tempo real</p>
                        </div>
                        <div class="ml-auto">
                            <button class="btn-hamburger" data-sidebar-toggle aria-label="Abrir/Fechar Menu">
                                <span class="hamburger-line"></span>
                                <span class="hamburger-line"></span>
                                <span class="hamburger-line"></span>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary btn-sm" onclick="exportWindData()">
                            <i class="fas fa-download"></i>
                            Exportar
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="refreshWindData()">
                            <i class="fas fa-sync-alt"></i>
                            Atualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-body">
            <!-- Cards de Estatísticas do Vento -->
            <div class="wind-stats-grid">
                <div class="wind-stat-card">
                    <div class="wind-stat-header">
                        <div class="wind-stat-icon speed">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div class="wind-stat-content">
                            <h3>Velocidade Atual</h3>
                            <div class="wind-stat-value">
                                <span id="currentWindSpeed">12.5</span>
                                <span class="wind-stat-unit">km/h</span>
                            </div>
                            <div class="wind-stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>+2.3 km/h desde ontem</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wind-stat-card">
                    <div class="wind-stat-header">
                        <div class="wind-stat-icon direction">
                            <i class="fas fa-compass"></i>
                        </div>
                        <div class="wind-stat-content">
                            <h3>Direção Atual</h3>
                            <div class="wind-stat-value">
                                <span id="currentWindDirection">NE</span>
                                <span class="wind-stat-unit">(45°)</span>
                            </div>
                            <div class="wind-compass">
                                <div class="compass-face">
                                    <div class="compass-direction north">N</div>
                                    <div class="compass-direction east">E</div>
                                    <div class="compass-direction south">S</div>
                                    <div class="compass-direction west">O</div>
                                    <div class="compass-direction northeast">NE</div>
                                    <div class="compass-direction southeast">SE</div>
                                    <div class="compass-direction southwest">SO</div>
                                    <div class="compass-direction northwest">NO</div>
                                    <div class="wind-arrow" id="windArrow"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wind-stat-card">
                    <div class="wind-stat-header">
                        <div class="wind-stat-icon gust">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="wind-stat-content">
                            <h3>Rajada Máxima</h3>
                            <div class="wind-stat-value">
                                <span id="maxWindGust">28.7</span>
                                <span class="wind-stat-unit">km/h</span>
                            </div>
                            <div class="wind-stat-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span>-5.2 km/h desde ontem</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wind-stat-card" style="display: none;">
                    <div class="wind-stat-header">
                        <div class="wind-stat-icon pressure">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                        <div class="wind-stat-content">
                            <h3>Pressão Atmosférica</h3>
                            <div class="wind-stat-value">
                                <span id="atmosphericPressure">1013.2</span>
                                <span class="wind-stat-unit">hPa</span>
                            </div>
                            <div class="wind-stat-trend trend-stable">
                                <i class="fas fa-minus"></i>
                                <span>Estável</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos de Vento -->
            <div class="wind-charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Velocidade do Vento
                        </h3>
                        <select class="filter-selector" id="speedFilter" onchange="updateSpeedChart()">
                            <option value="24h">Últimas 24h</option>
                            <option value="7d">Últimos 7 dias</option>
                            <option value="30d">Últimos 30 dias</option>
                        </select>
                    </div>
                    <canvas id="windSpeedChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-compass"></i>
                            Direção do Vento
                        </h3>
                        <select class="filter-selector" id="directionFilter" onchange="updateDirectionChart()">
                            <option value="24h">Últimas 24h</option>
                            <option value="7d">Últimos 7 dias</option>
                            <option value="30d">Últimos 30 dias</option>
                        </select>
                    </div>
                    <canvas id="windDirectionChart"></canvas>
                </div>
            </div>

            <!-- Rosa dos Ventos -->
            <div class="wind-rose-container">
                <h3 class="chart-title">
                    <i class="fas fa-dharmachakra"></i>
                    Rosa dos Ventos - Frequência por Direção
                </h3>
                <div class="wind-rose" id="windRose">
                    <!-- Canvas será inserido aqui dinamicamente -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../assets/js/app.js"></script>
    <script>
        // Variáveis globais dos gráficos
        let windSpeedChart = null;
        let windDirectionChart = null;
        let windRoseChart = null;

        // Dados de vento
        const windData = {
            current: {
                speed: 0,
                direction: 0,
                directionText: '-',
                gust: 0,
                pressure: 0
            },
            history: []
        };

        // Função para converter graus em direção cardeal
        function degreesToCardinal(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            return directions[Math.round(degrees / 22.5) % 16];
        }

        // Função para buscar dados históricos da API (sem cache - sempre dados frescos)
        async function fetchWindData(period = '24h') {
            try {
                LoadingManager.show();
                
                const companyId = window.adminViewCompanyId || AuthManager.getCompanyId();
                const data = await ApiClient.getSensorsHistory(companyId, period);
                
                console.log('Dados recebidos da API:', data);
                
                if (data && data.dados && data.dados.length > 0) {
                    // Processar dados históricos
                    windData.history = data.dados.map(item => {
                        const direcaoCardinal = item.direcao_vento_cardinal || '-';
                        const direcaoGraus = WindUtils.getWindRotation(direcaoCardinal);
                        
                        return {
                            timestamp: item.timestamp,
                            speed: item.velocidade_vento || 0,
                            gust: item.velocidade_vento ? item.velocidade_vento * 1.3 : 0,
                            direction: direcaoGraus,
                            directionCardinal: direcaoCardinal,
                            pressure: item.pressao || 0,
                            temperature: item.temperatura || 0,
                            humidity: item.umidade_solo || 0
                        };
                    });
                    
                    console.log(`${windData.history.length} leituras processadas`);
                    
                    // Atualizar dados atuais com a leitura mais recente
                    extractCurrentDataFromHistory();
                } else {
                    console.warn('Nenhum dado de vento disponível na API');
                    windData.history = [];
                }
                
                LoadingManager.hide();
                return windData.history;
            } catch (error) {
                console.error('Erro ao buscar dados de vento:', error);
                LoadingManager.hide();
                notificationManager.error('Erro', 'Falha ao carregar dados de vento');
                return [];
            }
        }

        // Função para extrair dados atuais do histórico
        function extractCurrentDataFromHistory() {
            if (windData.history.length === 0) {
                console.warn('Sem dados históricos para extrair dados atuais');
                return;
            }
            
            // Pegar a leitura mais recente por timestamp (ordenar por data DESC)
            const latest = windData.history.reduce((newest, current) => {
                const newestTime = new Date(newest.timestamp).getTime();
                const currentTime = new Date(current.timestamp).getTime();
                return currentTime > newestTime ? current : newest;
            });
            
            windData.current = {
                speed: latest.speed || 0,
                direction: latest.direction || 0,
                directionText: latest.directionCardinal || '-',
                gust: latest.gust || (latest.speed ? latest.speed * 1.3 : 0),
                pressure: latest.pressure || 0
            };
            
            console.log('Dados atuais extraídos (mais recente por timestamp):', windData.current, 'Timestamp:', latest.timestamp);
        }

        // Função para atualizar gráfico de velocidade do vento
        async function updateSpeedChart() {
            const period = document.getElementById('speedFilter').value;
            
            // Buscar dados da API
            await fetchWindData(period);
            
            if (!windSpeedChart || windData.history.length === 0) return;
            
            const filteredData = windData.history;
            
            const labels = filteredData.map(item => {
                const date = new Date(item.timestamp);
                if (period === '24h') {
                    return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                }
            });
            
            windSpeedChart.data.labels = labels;
            windSpeedChart.data.datasets = [
                {
                    label: 'Velocidade do Vento',
                    data: filteredData.map(item => item.speed),
                    borderColor: '#3182ce',
                    backgroundColor: 'rgba(49, 130, 206, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }
            ];
            
            windSpeedChart.update();
        }

        // Função para atualizar gráfico de direção do vento
        async function updateDirectionChart() {
            const period = document.getElementById('directionFilter').value;
            
            // Usar os dados já carregados se o período for o mesmo
            if (windData.history.length === 0) {
                await fetchWindData(period);
            }
            
            if (!windDirectionChart) {
                console.warn('Gráfico de direção não inicializado');
                return;
            }
            
            if (windData.history.length === 0) {
                console.warn('Sem dados históricos para exibir');
                // Mesmo sem dados, inicializar a rosa dos ventos vazia
                updateWindRose({});
                return;
            }
            
            const filteredData = windData.history;
            
            // Calcular frequência de cada direção para rosa dos ventos
            const stats = WindUtils.calcularEstatisticasVento(filteredData);
            console.log('Estatísticas calculadas:', stats);
            updateWindRose(stats.frequenciasDirecao);
            
            const labels = filteredData.map(item => {
                const date = new Date(item.timestamp);
                if (period === '24h') {
                    return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                }
            });
            
            windDirectionChart.data.labels = labels;
            windDirectionChart.data.datasets = [{
                label: 'Direção do Vento',
                data: filteredData.map((item, index) => ({
                    x: index,
                    y: item.direction,
                    cardinal: item.directionCardinal
                })),
                borderColor: '#38a169',
                backgroundColor: 'rgba(56, 161, 105, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6,
                showLine: true
            }];
            
            windDirectionChart.update();
        }

        // Função para atualizar rosa dos ventos
        function updateWindRose(frequencias) {
            const roseContainer = document.getElementById('windRose');
            if (!roseContainer) {
                console.warn('Container da rosa dos ventos não encontrado');
                return;
            }
            
            // Criar canvas para rosa dos ventos se não existir
            let canvas = roseContainer.querySelector('canvas');
            if (!canvas) {
                // Limpar container
                roseContainer.innerHTML = '';
                canvas = document.createElement('canvas');
                canvas.id = 'windRoseCanvas';
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
                roseContainer.appendChild(canvas);
            }
            
            const ctx = canvas.getContext('2d');
            
            // Preparar dados para o gráfico polar
            const direcoes = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const valores = direcoes.map(dir => frequencias[dir] || 0);
            
            // Verificar se há dados
            const totalLeituras = valores.reduce((a, b) => a + b, 0);
            console.log('Rosa dos Ventos - Total de leituras:', totalLeituras, 'Frequências:', frequencias);
            
            // Destruir gráfico anterior se existir
            if (windRoseChart) {
                windRoseChart.destroy();
            }
            
            windRoseChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: direcoes.map(dir => `${dir} (${WindUtils.getDirecaoCompleta(dir)})`),
                    datasets: [{
                        label: 'Frequência da Direção',
                        data: valores,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(199, 199, 199, 0.6)',
                            'rgba(83, 102, 255, 0.6)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 206, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)',
                            'rgb(255, 159, 64)',
                            'rgb(199, 199, 199)',
                            'rgb(83, 102, 255)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed.r || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} leituras (${percentage}%)`;
                                }
                            }
                        },
                        title: {
                            display: totalLeituras === 0,
                            text: 'Sem dados disponíveis',
                            font: {
                                size: 14
                            },
                            color: '#999'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                display: true,
                                stepSize: 1,
                                backdropColor: 'rgba(255, 255, 255, 0.8)',
                                backdropPadding: 4,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                padding: 10
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar a bússola
        function updateWindCompass() {
            const arrow = document.getElementById('windArrow');
            if (!arrow) return;
            
            const direction = windData.current.direction;
            // A seta agora aponta para onde o vento está indo (rotação direta)
            arrow.style.transform = `translate(-50%, -50%) rotate(${direction}deg)`;
            
            // Atualizar texto da direção
            const directionElement = document.getElementById('currentWindDirection');
            if (directionElement) {
                directionElement.textContent = windData.current.directionText;
            }
        }

        // Função para atualizar valores atuais
        function updateCurrentValues() {
            // Velocidade atual
            const speedElement = document.getElementById('currentWindSpeed');
            if (speedElement) {
                speedElement.textContent = windData.current.speed.toFixed(1);
            }
            
            // Direção atual
            const directionElement = document.getElementById('currentWindDirection');
            if (directionElement) {
                directionElement.textContent = windData.current.directionText;
            }
            
            // Rajada máxima
            const gustElement = document.getElementById('maxWindGust');
            if (gustElement) {
                gustElement.textContent = windData.current.gust.toFixed(1);
            }
            
            // Pressão (card oculto)
            // const pressureElement = document.getElementById('atmosphericPressure');
            // if (pressureElement) {
            //     pressureElement.textContent = windData.current.pressure.toFixed(1);
            // }
            
            // Atualizar estatísticas de tendência se houver dados históricos
            if (windData.history.length > 1) {
                updateTrends();
            }
        }

        // Função para atualizar tendências
        function updateTrends() {
            const stats = WindUtils.calcularEstatisticasVento(windData.history);
            
            // Calcular tendência de velocidade (comparação com média)
            const currentSpeed = windData.current.speed;
            const avgSpeed = parseFloat(stats.velocidadeMedia);
            const speedDiff = currentSpeed - avgSpeed;
            
            // Atualizar visualização de tendência (você pode adicionar elementos HTML para isso)
            console.log(`Tendência de velocidade: ${speedDiff > 0 ? '+' : ''}${speedDiff.toFixed(1)} km/h em relação à média`);
        }

        // Função para buscar e atualizar todos os dados
        async function refreshWindData() {
            try {
                LoadingManager.show();
                
                // Buscar dados históricos
                await fetchWindData('24h');
                
                // Extrair dados atuais do histórico
                extractCurrentDataFromHistory();
                
                // Atualizar interface
                updateCurrentValues();
                updateWindCompass();
                updateSpeedChart();
                updateDirectionChart();
                
                LoadingManager.hide();
                // notificationManager.success('Atualizado', 'Dados de vento atualizados com sucesso');
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
                LoadingManager.hide();
                notificationManager.error('Erro', 'Falha ao atualizar dados de vento');
            }
        }

        // Função de inicialização
        async function initWindPage() {
            // Verificar autenticação
            if (!AuthManager.isAuthenticated()) {
                window.location.href = '../index.html';
                return;
            }

            // Configurar sidebar
            initializeSidebarEvents();

            // Verificar modo admin
            checkAdminMode();

            // Inicializar gráficos
            initWindCharts();

            // Buscar e atualizar dados
            await refreshWindData();

            // Configurar atualização automática a cada 30 segundos
            setInterval(refreshWindData, 30000);

            console.log('Página de vento inicializada com sucesso');
        }

        // Função para inicializar eventos da sidebar
        function initializeSidebarEvents() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('[data-sidebar-overlay]');
            const hamburger = document.querySelector('[data-sidebar-toggle]');
            
            // Variável para controlar estado da sidebar
            let sidebarAberto = false;
            
            // Inicializar estado da sidebar
            if (sidebar && overlay) {
                if (window.innerWidth <= 1024) {
                    sidebar.style.cssText = `
                        position: fixed !important;
                        left: -300px !important;
                        top: 0 !important;
                        width: 280px !important;
                        height: 100vh !important;
                        z-index: -1 !important;
                        transform: translateX(-100%) !important;
                    `;
                    
                    overlay.style.cssText = `
                        opacity: 0 !important;
                        visibility: hidden !important;
                        pointer-events: none !important;
                        z-index: -1 !important;
                    `;
                }
            }
            
            // Event listener para toggle da sidebar
            if (hamburger) {
                hamburger.addEventListener('click', function() {
                    if (sidebarAberto) {
                        fecharSidebar();
                    } else {
                        abrirSidebar();
                    }
                });
            }
            
            // Event listener para fechar sidebar clicando no overlay
            if (overlay) {
                overlay.addEventListener('click', fecharSidebar);
            }
            
            function abrirSidebar() {
                if (!sidebar || !overlay) return;
                
                sidebar.style.cssText = `
                    position: fixed !important;
                    left: 0 !important;
                    top: 0 !important;
                    width: 280px !important;
                    height: 100vh !important;
                    z-index: 9999 !important;
                    background: white !important;
                    transform: translateX(0) !important;
                    transition: transform 0.3s ease !important;
                    box-shadow: 0 0 30px rgba(0,0,0,0.5) !important;
                `;
                
                overlay.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: rgba(0,0,0,0.5) !important;
                    z-index: 998 !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    pointer-events: auto !important;
                `;
                
                if (hamburger) hamburger.classList.add('active');
                document.body.style.overflow = 'hidden';
                sidebarAberto = true;
            }
            
            function fecharSidebar() {
                if (!sidebar || !overlay) return;
                
                sidebar.style.cssText = `
                    position: fixed !important;
                    left: -300px !important;
                    top: 0 !important;
                    width: 280px !important;
                    height: 100vh !important;
                    z-index: -1 !important;
                    transform: translateX(-100%) !important;
                    transition: all 0.3s ease !important;
                `;
                
                overlay.style.cssText = `
                    opacity: 0 !important;
                    visibility: hidden !important;
                    pointer-events: none !important;
                    z-index: -1 !important;
                    transition: all 0.3s ease !important;
                `;
                
                if (hamburger) hamburger.classList.remove('active');
                document.body.style.overflow = 'auto';
                sidebarAberto = false;
            }
        }

        // Função para verificar modo admin
        function checkAdminMode() {
            // Verificar se está no modo admin view
            const urlParams = new URLSearchParams(window.location.search);
            const adminCompanyId = urlParams.get('admin_company_id');
            
            if (adminCompanyId) {
                window.adminViewCompanyId = adminCompanyId;
                const statusBar = document.getElementById('adminStatusBar');
                if (statusBar) {
                    statusBar.style.display = 'flex';
                }
            }
        }

        // Função para sair do modo admin
        function exitAdminView() {
            window.adminViewCompanyId = null;
            const statusBar = document.getElementById('adminStatusBar');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
            // Remover parâmetro da URL
            const url = new URL(window.location);
            url.searchParams.delete('admin_company_id');
            window.history.replaceState({}, '', url);
        }

        // Função para logout
        function logout() {
            if (AuthManager && AuthManager.logout) {
                AuthManager.logout();
            }
            window.location.href = '../index.html';
        }

        // Função para exportar dados do vento
        function exportWindData() {
            try {
                if (windData.history.length === 0) {
                    notificationManager.warning('Sem dados', 'Não há dados de vento para exportar');
                    return;
                }
                
                const csv = convertWindDataToCSV(windData.history);
                downloadCSV(csv, `dados-vento-${new Date().toISOString().split('T')[0]}.csv`);
                notificationManager.success('Exportado', 'Dados de vento exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                notificationManager.error('Erro', 'Falha ao exportar dados de vento');
            }
        }

        function convertWindDataToCSV(data) {
            const headers = ['Data/Hora', 'Velocidade (km/h)', 'Direção (°)', 'Direção Cardinal', 'Pressão (hPa)', 'Temperatura (°C)', 'Umidade (%)'];
            const rows = data.map(item => {
                const date = new Date(item.timestamp);
                return [
                    date.toLocaleString('pt-BR'),
                    item.speed.toFixed(1),
                    item.direction.toFixed(0),
                    item.directionCardinal || '-',
                    item.pressure.toFixed(1),
                    (item.temperature || 0).toFixed(1),
                    (item.humidity || 0).toFixed(1)
                ];
            });
            
            return [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Função para inicializar gráficos
        function initWindCharts() {
            // Gráfico de velocidade do vento
            const speedCtx = document.getElementById('windSpeedChart').getContext('2d');
            windSpeedChart = new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} km/h`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tempo'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Velocidade (km/h)'
                            },
                            beginAtZero: true
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Gráfico de direção do vento
            const directionCtx = document.getElementById('windDirectionChart').getContext('2d');
            windDirectionChart = new Chart(directionCtx, {
                type: 'scatter',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const direction = context.parsed.y;
                                    const cardinal = degreesToCardinal(direction);
                                    return `Direção: ${direction.toFixed(0)}° (${cardinal})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tempo'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Direção (graus)'
                            },
                            min: 0,
                            max: 360,
                            ticks: {
                                stepSize: 45,
                                callback: function(value) {
                                    return value + '°';
                                }
                            }
                        }
                    }
                }
            });

            // Carregar dados iniciais
            updateSpeedChart();
            updateDirectionChart();
        }

        // Função para interceptar cliques em links desabilitados
        function handleDisabledLinks() {
            document.querySelectorAll('.sidebar-nav-link.disabled').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    notificationManager.info('Em breve', 'Esta funcionalidade estará disponível em breve');
                });
            });
        }

        // Inicializar página quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            initWindPage();
            handleDisabledLinks();
            
            // Event listener para o botão de logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
        });

        // ===== OTIMIZAÇÕES DE PERFORMANCE =====
        
        // Handler de resize dos gráficos
        function handleResize() {
            // Ajustar gráficos quando a tela redimensiona
            if (speedChart) {
                speedChart.resize();
            }
            if (directionChart) {
                directionChart.resize();
            }
            if (windRoseChart) {
                windRoseChart.resize();
            }
        }
        
        // Debounce para otimizar performance no resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 150);
        });
        
        // Executar uma vez no carregamento
        handleResize();

    </script>
</body>
</html>